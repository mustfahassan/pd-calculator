<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PD Measurement</title>
    <style>
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .permission-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }

        .permission-box button {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        .permission-box button:hover {
            background: #0056b3;
        }

        #errorMessage {
            color: red;
            margin-top: 10px;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="permission-overlay" id="permissionDialog">
        <div class="permission-box">
            <h3>Camera Access Required</h3>
            <p>To measure your PD, we need access to your camera. Please click the button below and allow camera access when prompted.</p>
            <button onclick="requestCameraAccess()">Enable Camera</button>
            <p id="errorMessage"></p>
        </div>
    </div>

    <div class="container">
        <h1>PD Measurement</h1>
        
        <div class="video-container">
            <img id="videoFeed" src="{{ url_for('pupil.video_feed') }}" alt="Video feed" style="display: none;">
            <div class="progress-bar" id="stabilityProgress"></div>
            <div class="status-overlay" id="statusMessage">Position your face within the guide...</div>
            <div class="countdown-overlay" id="countdownOverlay">
                <span id="countdown">3</span>
            </div>
        </div>

        <div class="controls">
            <button class="start-btn" id="measureBtn">
                üì∑ Start Measurement
            </button>
            <button class="stop-btn" id="stopBtn" style="display: none;">
                ‚èπÔ∏è Stop
            </button>
        </div>

        <div class="results-card" id="resultsCard" style="display: none;">
            <div class="results-header">
                ‚úì Measurement Complete
            </div>
            
            <div class="results-grid">
                <div class="result-box">
                    <div class="result-title">
                        üëÅÔ∏è Pupillary Distance
                    </div>
                    <div class="measurement-value" id="pdValue">-- mm</div>
                </div>
                
                <div class="result-box">
                    <div class="result-title">
                        ‚ö° Measurement Quality
                    </div>
                    <div class="measurement-value success" id="confidenceValue">--%</div>
                    <div class="confidence">Confidence Score</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const measureBtn = document.getElementById('measureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const videoFeed = document.getElementById('videoFeed');
        const permissionDialog = document.getElementById('permissionDialog');
        const errorMessage = document.getElementById('errorMessage');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownSpan = document.getElementById('countdown');
        const pdValue = document.getElementById('pdValue');
        const confidenceValue = document.getElementById('confidenceValue');
        const statusMessage = document.getElementById('statusMessage');
        const stabilityProgress = document.getElementById('stabilityProgress');
        const resultsCard = document.getElementById('resultsCard');

        let statusInterval;
        let hasPermission = false;

        async function requestCameraAccess() {
            try {
                // First, try to get camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // If successful, stop the test stream
                stream.getTracks().forEach(track => track.stop());
                
                // Set permission flag and hide dialog
                hasPermission = true;
                permissionDialog.style.display = 'none';
                errorMessage.style.display = 'none';
                
                // Start the measurement process
                startMeasurement();
            } catch (error) {
                console.error('Camera access error:', error);
                errorMessage.textContent = "Camera access was denied. Please enable camera access in your browser settings.";
                errorMessage.style.display = 'block';
            }
        }

        async function startMeasurement() {
            if (!hasPermission) {
                permissionDialog.style.display = 'flex';
                return;
            }

            try {
                const response = await fetch('/start_camera', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    videoFeed.style.display = 'block';
                    stopBtn.style.display = 'block';
                    measureBtn.style.display = 'none';
                    // Add timestamp to prevent caching
                    videoFeed.src = "{{ url_for('pupil.video_feed') }}?" + new Date().getTime();
                    statusInterval = setInterval(checkStatus, 100);
                } else {
                    throw new Error(data.message || 'Failed to start camera');
                }
            } catch (error) {
                console.error('Error starting measurement:', error);
                errorMessage.textContent = "Error starting camera. Please try again.";
                errorMessage.style.display = 'block';
                permissionDialog.style.display = 'flex';
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/get_status');
                const data = await response.json();
                
                const progressPercent = (data.stable_frames / data.threshold) * 100;
                stabilityProgress.style.width = `${progressPercent}%`;
                statusMessage.textContent = data.message;
                
                if (data.is_measuring) {
                    clearInterval(statusInterval);
                    await startCountdown();
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function startCountdown() {
            countdownOverlay.style.display = 'flex';
            let count = 3;
            
            return new Promise((resolve) => {
                const countdownTimer = setInterval(async () => {
                    countdownSpan.textContent = count;
                    count--;
                    
                    if (count < 0) {
                        clearInterval(countdownTimer);
                        countdownOverlay.style.display = 'none';
                        await getMeasurement();
                        resolve();
                    }
                }, 1000);
            });
        }

        async function getMeasurement() {
            try {
                const response = await fetch('/get_measurement');
                const data = await response.json();

                if (data.pd_mm) {
                    pdValue.textContent = `${Math.round(data.pd_mm)} mm`;
                    const qualityScore = Math.round(data.confidence);
                    confidenceValue.textContent = `${qualityScore}%`;

                    confidenceValue.className = 'measurement-value';
                    if (qualityScore >= 90) {
                        confidenceValue.classList.add('success');
                    } else if (qualityScore >= 75) {
                        confidenceValue.classList.add('good');
                    } else {
                        confidenceValue.classList.add('warning');
                    }

                    resultsCard.style.display = 'block';
                    await stopMeasurement();
                    measureBtn.textContent = 'üì∑ Measure Again';
                } else {
                    handleMeasurementError("Measurement failed. Please try again.");
                }
            } catch (error) {
                console.error('Error getting measurement:', error);
                handleMeasurementError("Error getting measurement. Please try again.");
            }
        }

        async function stopMeasurement() {
            clearInterval(statusInterval);
            try {
                await fetch('/stop', { method: 'POST' });
                videoFeed.style.display = 'none';
                stopBtn.style.display = 'none';
                measureBtn.style.display = 'block';
                stabilityProgress.style.width = '0%';
            } catch (error) {
                console.error('Stop error:', error);
            }
        }

        function handleMeasurementError(message) {
            pdValue.textContent = "-- mm";
            confidenceValue.textContent = "--%";
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
        }

        // Add click event listeners
        measureBtn.addEventListener('click', startMeasurement);
        stopBtn.addEventListener('click', stopMeasurement);

        // Check camera permission on page load
        window.addEventListener('load', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                hasPermission = true;
            } catch (error) {
                console.log('Initial camera check failed:', error);
                permissionDialog.style.display = 'flex';
            }
        });
    </script>
</body>
</html>